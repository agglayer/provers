[tasks.generate-proto]
dependencies = ["generate-aggkit-proto", "generate-agglayer-proto", "generate-op-succinct-grpc-proto"]

[tasks.generate-aggkit-proto]
command = "buf"
args = ["generate", "--template", "buf.aggkit-prover.gen.yaml"]
dependencies = ["install-proto-deps"]

[tasks.generate-agglayer-proto]
command = "buf"
args = ["generate", "--template", "buf.agglayer-prover.gen.yaml"]
dependencies = ["install-proto-deps"]

[tasks.generate-op-succinct-grpc-proto]
command = "buf"
args = ["generate", "--template", "buf.op-succinct-grpc.gen.yaml"]
dependencies = ["install-proto-deps"]

[tasks.install-proto-deps]
dependencies = [
    "install-buf",
    "install-protoc-gen-prost",
    "install-protoc-gen-prost-serde",
    "install-protoc-gen-prost-crate",
    "install-protoc-gen-tonic",
]

[tasks.install-buf]
condition = { env_not_set = ["GITHUB_RUN_ID"] }
run_task = [
    { name = "install-buf-linux", condition = { platforms = [
        "linux",
    ] } },
    { name = "install-buf-mac", condition = { platforms = [
        "mac",
    ] } },
]

[tasks.install-buf-linux]
script = '''
npm install @bufbuild/buf
'''

[tasks.install-buf-mac]
script = '''
brew install bufbuild/buf/buf
'''

[tasks.install-protoc-gen-prost]
script = '''
cargo install --git https://github.com/agglayer/protoc-gen-prost.git --tag protoc-gen-prost-v0.4.1 protoc-gen-prost
'''

[tasks.install-protoc-gen-prost-serde]
script = '''
cargo install --git https://github.com/agglayer/protoc-gen-prost.git --tag protoc-gen-prost-serde-v0.3.2 protoc-gen-prost-serde
'''

[tasks.install-protoc-gen-prost-crate]
script = '''
cargo install --git https://github.com/agglayer/protoc-gen-prost.git --tag protoc-gen-prost-crate-v0.4.2 protoc-gen-prost-crate
'''

[tasks.install-protoc-gen-tonic]
script = '''
cargo install --git https://github.com/agglayer/protoc-gen-prost.git --tag protoc-gen-tonic-v0.4.2 protoc-gen-tonic
'''
